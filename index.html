<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Mayday Console</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <!-- Leaflet for map -->
  <link
    rel="stylesheet"
    href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
    integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
    crossorigin=""
  />
  <script
    src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
    integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
    crossorigin=""
    defer
  ></script>

  <!-- chart.js for analytics -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js" defer></script>

  <style>
    :root {
      --bg: #050505;
      --bg-soft: #0b0b0d;
      --card: #111827;
      --accent: #b91c1c;
      --accent-soft: rgba(185, 28, 28, 0.14);
      --accent-strong: #dc2626;
      --border: #1f2933;
      --text: #f9fafb;
      --muted: #9ca3af;
      --muted-light: #6b7280;
      --radius-lg: 18px;
      --radius-pill: 999px;
      --shadow-soft: 0 18px 40px rgba(0, 0, 0, 0.9);
      --transition-fast: 0.18s ease-out;
    }

    :root.light-mode {
      --bg: #f8f9fa;
      --bg-soft: #e9ecef;
      --card: #ffffff;
      --accent: #b91c1c;
      --accent-soft: rgba(185, 28, 28, 0.1);
      --accent-strong: #dc2626;
      --border: #dee2e6;
      --text: #212529;
      --muted: #6c757d;
      --muted-light: #adb5bd;
      --shadow-soft: 0 18px 40px rgba(0, 0, 0, 0.1);
    }

    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    body {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "SF Pro Text",
        sans-serif;
      background: radial-gradient(circle at top, #111827 0, #050505 55%);
      color: var(--text);
      min-height: 100vh;
      display: flex;
      align-items: stretch;
      justify-content: center;
      padding: 20px;
      transition: background 0.3s ease, color 0.3s ease;
    }

    :root.light-mode body {
      background: radial-gradient(circle at top, #e9ecef 0, #f8f9fa 55%);
    }

    #app-shell {
      width: 100%;
      max-width: 1240px;
      min-height: 650px;
      background: linear-gradient(145deg, #050505, #020203);
      border-radius: 28px;
      box-shadow: var(--shadow-soft);
      border: 1px solid rgba(148, 163, 184, 0.24);
      display: flex;
      overflow: hidden;
      position: relative;
      transition: background 0.3s ease, border-color 0.3s ease;
    }

    :root.light-mode #app-shell {
      background: linear-gradient(145deg, #ffffff, #f8f9fa);
      border: 1px solid rgba(0, 0, 0, 0.1);
    }

    /* ---------- LOGIN ---------- */

    #login-view {
      display: flex;
      width: 100%;
    }

    .login-panel {
      flex: 1;
      padding: 40px 42px;
      display: flex;
      flex-direction: column;
      justify-content: space-between;
      background: radial-gradient(circle at top left, #111827 0, #050505 60%);
      transition: background 0.3s ease;
    }

    :root.light-mode .login-panel {
      background: radial-gradient(circle at top left, #e9ecef 0, #f8f9fa 60%);
    }

    .login-header {
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    .brand-text-main {
      font-size: 1.1rem;
      letter-spacing: 0.3em;
      text-transform: uppercase;
    }

    .brand-text-sub {
      font-size: 0.75rem;
      text-transform: uppercase;
      letter-spacing: 0.16em;
      color: var(--muted);
    }

    .login-main h2 {
      margin-top: 24px;
      font-size: 1.6rem;
    }

    .login-main p {
      margin-top: 4px;
      color: var(--muted);
      font-size: 0.9rem;
    }

    .login-form {
      margin-top: 24px;
      display: flex;
      flex-direction: column;
      gap: 16px;
      max-width: 360px;
    }

    .field-group label {
      display: block;
      font-size: 0.76rem;
      text-transform: uppercase;
      letter-spacing: 0.16em;
      color: var(--muted);
      margin-bottom: 5px;
    }

    .field-group input {
      width: 100%;
      padding: 10px 12px;
      border-radius: 12px;
      border: 1px solid var(--border);
      background: rgba(15, 23, 42, 0.9);
      color: var(--text);
      font-size: 0.9rem;
      outline: none;
      transition: border-color var(--transition-fast),
        box-shadow var(--transition-fast),
        transform 0.08s ease-out;
    }

    :root.light-mode .field-group input {
      background: rgba(255, 255, 255, 0.9);
    }

    .field-group input:focus {
      border-color: var(--accent);
      box-shadow: 0 0 0 1px rgba(185, 28, 28, 0.5);
      transform: translateY(-1px);
    }

    .primary-btn {
      margin-top: 10px;
      padding: 10px 18px;
      border-radius: var(--radius-pill);
      border: none;
      background: linear-gradient(135deg, #b91c1c, #991b1b);
      color: #f9fafb;
      font-weight: 600;
      font-size: 0.9rem;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      box-shadow: 0 18px 45px rgba(185, 28, 28, 0.7);
      transition: transform 0.08s ease-out, box-shadow var(--transition-fast),
        filter var(--transition-fast);
    }

    .primary-btn:hover {
      transform: translateY(-1px);
      filter: brightness(1.05);
    }

    .primary-btn:active {
      transform: translateY(1px) scale(0.99);
      box-shadow: 0 8px 20px rgba(0, 0, 0, 0.8);
    }

    .login-note {
      margin-top: 6px;
      font-size: 0.78rem;
      color: var(--muted);
    }

    .login-footer {
      margin-top: 32px;
      font-size: 0.76rem;
      color: var(--muted);
      display: flex;
      justify-content: space-between;
      align-items: center;
      border-top: 1px solid rgba(31, 41, 55, 0.9);
      padding-top: 10px;
    }

    .pill {
      padding: 4px 10px;
      border-radius: var(--radius-pill);
      border: 1px solid var(--border);
      background: rgba(15, 23, 42, 0.95);
      font-size: 0.7rem;
      text-transform: uppercase;
      letter-spacing: 0.16em;
      transition: background 0.3s ease;
    }

    :root.light-mode .pill {
      background: rgba(255, 255, 255, 0.95);
    }

    .pill-dot {
      width: 7px;
      height: 7px;
      border-radius: 999px;
      background: var(--accent-strong);
      box-shadow: 0 0 0 6px rgba(220, 38, 38, 0.25);
    }

    .login-side {
      flex: 1;
      padding: 40px 42px;
      border-left: 1px solid var(--border);
      background: radial-gradient(circle at top, #1f2937 0, #050505 60%);
      display: flex;
      flex-direction: column;
      gap: 16px;
      transition: background 0.3s ease;
    }

    :root.light-mode .login-side {
      background: radial-gradient(circle at top, #f1f3f5 0, #f8f9fa 60%);
    }

    .side-card {
      border-radius: var(--radius-lg);
      background: rgba(15, 23, 42, 0.98);
      border: 1px solid var(--border);
      padding: 16px;
      box-shadow: 0 14px 35px rgba(0, 0, 0, 0.8);
      transition: background 0.3s ease;
    }

    :root.light-mode .side-card {
      background: rgba(255, 255, 255, 0.98);
      font-size: 0.82rem;
      color: var(--muted);
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    .side-card-title {
      font-size: 0.9rem;
      color: var(--text);
    }

    .side-tag {
      font-size: 0.68rem;
      text-transform: uppercase;
      letter-spacing: 0.16em;
      padding: 3px 8px;
      border-radius: var(--radius-pill);
      background: var(--accent-soft);
      border: 1px solid rgba(248, 113, 113, 0.6);
      color: #fecaca;
      align-self: flex-start;
    }

    :root.light-mode .side-tag {
      color: #991b1b;
      border: 1px solid rgba(185, 28, 28, 0.3);
    }

    /* ---------- APP MAIN ---------- */

    #app-main {
      display: none;
      width: 100%;
    }

    .sidebar {
      width: 230px;
      background: radial-gradient(circle at top, #111827 0, #020203 60%);
      border-right: 1px solid var(--border);
      padding: 18px 18px 16px 18px;
      display: flex;
      flex-direction: column;
      gap: 16px;
      transition: background 0.3s ease;
    }

    :root.light-mode .sidebar {
      background: radial-gradient(circle at top, #ffffff 0, #f8f9fa 60%);
    }

    .sidebar-header {
      font-size: 0.92rem;
      text-transform: uppercase;
      letter-spacing: 0.24em;
    }

    .sidebar-sub {
      font-size: 0.7rem;
      color: var(--muted);
      margin-top: 2px;
      text-transform: uppercase;
      letter-spacing: 0.16em;
    }

    .nav-list {
      list-style: none;
      margin-top: 18px;
      display: flex;
      flex-direction: column;
      gap: 4px;
    }

    .nav-item button {
      width: 100%;
      text-align: left;
      background: transparent;
      border: none;
      color: var(--muted);
      font-size: 0.85rem;
      padding: 7px 10px;
      border-radius: var(--radius-pill);
      display: flex;
      align-items: center;
      gap: 8px;
      cursor: pointer;
      transition: background var(--transition-fast), color var(--transition-fast),
        transform 0.08s ease-out;
    }

    .nav-item button span.icon {
      font-size: 0.9rem;
    }

    .nav-item button.active {
      background: var(--accent-soft);
      color: #fee2e2;
      transform: translateY(-1px);
      border: 1px solid rgba(248, 113, 113, 0.9);
    }

    :root.light-mode .nav-item button.active {
      color: #991b1b;
    }

    .nav-item button:hover {
      background: rgba(15, 23, 42, 0.95);
      color: var(--text);
    }

    :root.light-mode .nav-item button:hover {
      background: rgba(0, 0, 0, 0.05);
      color: var(--text);
    }

    .sidebar-footer {
      margin-top: auto;
      font-size: 0.75rem;
      color: var(--muted);
      border-top: 1px solid rgba(31, 41, 55, 0.9);
      padding-top: 10px;
      display: flex;
      flex-direction: column;
      gap: 8px;
      transition: border-color 0.3s ease;
    }

    :root.light-mode .sidebar-footer {
      border-top: 1px solid rgba(0, 0, 0, 0.1);
    }

    .logout-btn {
      border: none;
      background: rgba(15, 23, 42, 0.96);
      color: #fecaca;
      padding: 6px 10px;
      border-radius: var(--radius-pill);
      font-size: 0.78rem;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      gap: 6px;
      border: 1px solid rgba(248, 113, 113, 0.6);
      transition: background var(--transition-fast),
        transform 0.08s ease-out;
    }

    :root.light-mode .logout-btn {
      background: rgba(255, 255, 255, 0.96);
      color: #991b1b;
      border: 1px solid rgba(185, 28, 28, 0.3);
    }

    .logout-btn:hover {
      background: rgba(127, 29, 29, 0.7);
      transform: translateY(-0.5px);
    }

    :root.light-mode .logout-btn:hover {
      background: rgba(185, 28, 28, 0.1);
      color: #dc2626;
    }

    .content {
      flex: 1;
      padding: 18px 20px 20px 20px;
      display: flex;
      flex-direction: column;
      gap: 12px;
    }

    .content-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 10px;
    }

    .content-header-left h2 {
      font-size: 1.3rem;
    }

    .content-header-left p {
      font-size: 0.86rem;
      color: var(--muted);
    }

    .user-chip {
      padding: 6px 10px;
      border-radius: var(--radius-pill);
      background: rgba(15, 23, 42, 0.96);
      border: 1px solid var(--border);
      transition: background 0.3s ease;
    }

    :root.light-mode .user-chip {
      background: rgba(255, 255, 255, 0.96);
      font-size: 0.82rem;
      display: inline-flex;
      align-items: center;
      gap: 8px;
      cursor: pointer;
    }

    .user-avatar {
      width: 24px;
      height: 24px;
      border-radius: 999px;
      background: #111827;
      border: 1px solid rgba(248, 113, 113, 0.8);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 0.85rem;
      font-weight: 600;
    }

    /* ---------- PAGES ---------- */

    .page-section {
      display: none;
      flex: 1;
      gap: 12px;
      overflow: hidden;
    }

    .page-section.active {
      display: flex;
    }

    .card {
      border-radius: var(--radius-lg);
      background: var(--card);
      border: 1px solid var(--border);
      padding: 14px 16px;
      box-shadow: 0 12px 30px rgba(0, 0, 0, 0.8);
      display: flex;
      flex-direction: column;
      gap: 10px;
      width: 100%;
    }

    .card-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 8px;
    }

    .card-header h3 {
      font-size: 0.98rem;
    }

    .card-header p {
      font-size: 0.78rem;
      color: var(--muted);
    }

    .card-tag {
      font-size: 0.68rem;
      text-transform: uppercase;
      letter-spacing: 0.16em;
      padding: 4px 9px;
      border-radius: var(--radius-pill);
      background: var(--accent-soft);
      border: 1px solid rgba(248, 113, 113, 0.8);
      color: #fee2e2;
    }

    :root.light-mode .card-tag {
      color: #991b1b;
      border: 1px solid rgba(185, 28, 28, 0.3);
    }

    .dashboard-grid {
      display: grid;
      grid-template-columns: 1.4fr 1.2fr;
      gap: 12px;
      width: 100%;
    }

    .form-grid {
      display: grid;
      grid-template-columns: repeat(2, minmax(0, 1fr));
      gap: 10px;
      margin-top: 8px;
    }

    select,
    input[type="number"] {
      width: 100%;
      padding: 9px 11px;
      border-radius: 11px;
      border: 1px solid var(--border);
      background: rgba(15, 23, 42, 0.95);
      color: var(--text);
      font-size: 0.86rem;
      outline: none;
      transition: border-color var(--transition-fast),
        box-shadow var(--transition-fast),
        transform 0.08s ease-out;
    }

    :root.light-mode select,
    :root.light-mode input[type="number"],
    :root.light-mode input[type="text"].address-input {
      background: rgba(255, 255, 255, 0.95);
    }

    .address-input {
      width: 100%;
      padding: 9px 11px;
      border-radius: 11px;
      border: 1px solid var(--border);
      background: rgba(15, 23, 42, 0.95);
      color: var(--text);
      font-size: 0.86rem;
      outline: none;
      transition: border-color var(--transition-fast), box-shadow var(--transition-fast), transform 0.08s ease-out, background 0.3s ease;
    }

    select:focus,
    input[type="number"]:focus,
    input[type="text"]:focus {
      border-color: var(--accent);
      box-shadow: 0 0 0 1px rgba(185, 28, 28, 0.5);
      transform: translateY(-1px);
    }

    .mission-submit-row {
      margin-top: 10px;
      display: flex;
      justify-content: flex-end;
    }

    #map {
      width: 100%;
      height: 260px;
      border-radius: 16px;
      border: 1px solid var(--border);
      overflow: hidden;
    }

    /* leaflet attribution text styling for light mode */
    :root.light-mode .leaflet-control-attribution {
      background: rgba(255, 255, 255, 0.8) !important;
      color: #495057 !important;
    }

    :root.light-mode .leaflet-control-attribution a {
      color: #495057 !important;
    }

    .status-banner {
      margin-top: 8px;
      border-radius: 12px;
      padding: 8px 10px;
      font-size: 0.8rem;
      display: flex;
      align-items: center;
      gap: 8px;
      border: 1px solid rgba(52, 211, 153, 0.5);
      background: rgba(6, 78, 59, 0.4);
      color: #bbf7d0;
    }

    .status-banner.negative {
      border-color: rgba(248, 113, 113, 0.8);
      background: rgba(127, 29, 29, 0.6);
      color: #fee2e2;
    }

    .status-banner.loading {
      border-color: rgba(59, 130, 246, 0.8);
      background: rgba(30, 58, 138, 0.6);
      color: #dbeafe;
    }

    .status-dot.spinning {
      animation: spin 1s linear infinite;
    }

    @keyframes spin {
      from { transform: rotate(0deg); }
      to { transform: rotate(360deg); }
    }

    .status-dot {
      width: 9px;
      height: 9px;
      border-radius: 999px;
      background: #22c55e;
      box-shadow: 0 0 0 6px rgba(34, 197, 94, 0.3);
    }

    .status-dot.danger {
      background: #ef4444;
      box-shadow: 0 0 0 6px rgba(239, 68, 68, 0.3);
    }

    .status-dot.spinning {
      background: #3b82f6;
      box-shadow: 0 0 0 6px rgba(59, 130, 246, 0.3);
      box-shadow: 0 0 0 6px rgba(248, 113, 113, 0.4);
    }

    .table-wrapper {
      margin-top: 6px;
      border-radius: 14px;
      overflow: hidden;
      border: 1px solid var(--border);
      background: rgba(15, 23, 42, 0.98);
      transition: background 0.3s ease;
    }

    :root.light-mode .table-wrapper {
      background: rgba(255, 255, 255, 0.98);
    }

    table {
      width: 100%;
      border-collapse: collapse;
      font-size: 0.8rem;
    }

    th,
    td {
      padding: 7px 9px;
      text-align: left;
      border-bottom: 1px solid var(--border);
    }

    thead {
      background: #020617;
    }

    :root.light-mode thead {
      background: #f1f3f5;
    }

    th {
      text-transform: uppercase;
      letter-spacing: 0.14em;
      font-size: 0.68rem;
      color: var(--muted);
    }

    tbody tr:nth-child(even) {
      background: rgba(15, 23, 42, 0.96);
    }

    :root.light-mode tbody tr:nth-child(even) {
      background: rgba(0, 0, 0, 0.02);
    }

    .badge-status {
      padding: 2px 7px;
      border-radius: var(--radius-pill);
      font-size: 0.7rem;
      text-transform: uppercase;
      letter-spacing: 0.12em;
    }

    .badge-status.success {
      background: rgba(22, 163, 74, 0.22);
      color: #bbf7d0;
    }

    .badge-status.fail {
      background: rgba(127, 29, 29, 0.5);
      color: #fee2e2;
    }

    .badge-status.pending {
      background: rgba(250, 204, 21, 0.16);
      color: #facc15;
    }

    .secondary-btn {
      border-radius: var(--radius-pill);
      padding: 4px 9px;
      border: 1px solid var(--border);
      background: rgba(15, 23, 42, 0.96);
      color: var(--muted-light);
      font-size: 0.75rem;
      cursor: pointer;
      transition: background var(--transition-fast),
        color var(--transition-fast),
        transform 0.08s ease-out;
    }

    :root.light-mode .secondary-btn {
      background: rgba(255, 255, 255, 0.96);
      color: var(--muted);
    }

    .secondary-btn:hover {
      background: rgba(31, 41, 55, 1);
      color: var(--text);
      transform: translateY(-0.5px);
    }

    :root.light-mode .secondary-btn:hover {
      background: rgba(0, 0, 0, 0.05);
      color: var(--text);
    }

    /* Drones */
    .drones-layout {
      display: grid;
      grid-template-columns: 1.1fr 1fr;
      gap: 12px;
      width: 100%;
    }

    .tab-row {
      display: flex;
      gap: 8px;
      margin-top: 4px;
    }

    .tab-btn {
      border-radius: var(--radius-pill);
      padding: 4px 9px;
      border: 1px solid var(--border);
      background: rgba(15, 23, 42, 0.96);
      color: var(--muted-light);
      font-size: 0.75rem;
      cursor: pointer;
      transition: background 0.3s ease;
    }

    :root.light-mode .tab-btn {
      background: rgba(255, 255, 255, 0.96);
    }

    .tab-btn.active {
      background: var(--accent-soft);
      border-color: rgba(248, 113, 113, 0.8);
      color: #fee2e2;
    }

    :root.light-mode .tab-btn.active {
      color: #991b1b;
    }

    .note {
      font-size: 0.78rem;
      color: var(--muted);
      margin-top: 6px;
    }

    /* Profile */
    .profile-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 12px;
      width: 100%;
    }

    .profile-field {
      margin-top: 6px;
      display: flex;
      flex-direction: column;
      gap: 4px;
      font-size: 0.86rem;
    }

    .profile-field input,
    .profile-field select {
      max-width: 260px;
    }

    /* Analytics */
    #analytics-chart {
      width: 100% !important;
      height: 220px !important;
      max-height: 220px;
    }

    .analytics-legend {
      font-size: 0.78rem;
      color: var(--muted);
      display: flex;
      justify-content: space-between;
      margin-top: 4px;
    }

    /* Responsive */
    @media (max-width: 960px) {
      #app-shell {
        flex-direction: column;
      }
      .sidebar {
        display: none;
      }
      .content {
        padding: 16px;
      }
      #login-view {
        flex-direction: column;
      }
      .login-side {
        display: none;
      }
    }

    @media (max-width: 768px) {
      .dashboard-grid,
      .drones-layout,
      .profile-grid {
        grid-template-columns: 1fr;
      }
      .form-grid {
        grid-template-columns: 1fr;
      }
    }
  </style>
</head>
<body>
  <div id="app-shell">
    <!-- LOGIN -->
    <div id="login-view">
      <div class="login-panel">
        <div>
          <div class="login-header">
            <div class="brand-text-main">MAYDAY</div>
            <div class="brand-text-sub">DRONE DELIVERY CONTROL</div>
          </div>

          <div class="login-main">
            <h2 id="auth-title">Sign in to your console</h2>
            <p id="auth-subtitle">Track drones, missions, and manage delivery routes in one place.</p>

            <form id="login-form" class="login-form" style="display: block;">
              <div class="field-group">
                <label for="login-email">Email</label>
                <input id="login-email" type="email" required placeholder="you@example.com" />
              </div>
              <div class="field-group">
                <label for="login-password">Password</label>
                <input id="login-password" type="password" required placeholder="••••••••" />
              </div>
              <button type="submit" class="primary-btn">
                Sign In
                <span>→</span>
              </button>
              <p class="login-note" style="text-align: center; margin-top: 12px;">
                Don't have an account? <a href="#" id="switch-to-signup" style="color: var(--accent); text-decoration: none; cursor: pointer;">Sign up</a>
              </p>
            </form>

            <form id="signup-form" class="login-form" style="display: none;">
              <div class="field-group">
                <label for="signup-name">Name</label>
                <input id="signup-name" type="text" required placeholder="Your name" />
              </div>
              <div class="field-group">
                <label for="signup-email">Email</label>
                <input id="signup-email" type="email" required placeholder="you@example.com" />
              </div>
              <div class="field-group">
                <label for="signup-password">Password</label>
                <input id="signup-password" type="password" required placeholder="At least 6 characters" minlength="6" />
              </div>
              <div class="field-group">
                <label for="signup-password-confirm">Confirm Password</label>
                <input id="signup-password-confirm" type="password" required placeholder="Re-enter password" />
              </div>
              <button type="submit" class="primary-btn">
                Create Account
                <span>→</span>
              </button>
              <p class="login-note" style="text-align: center; margin-top: 12px;">
                Already have an account? <a href="#" id="switch-to-login" style="color: var(--accent); text-decoration: none; cursor: pointer;">Sign in</a>
              </p>
            </form>
          </div>
        </div>

        <div class="login-footer">
          <span>Battery and wind-aware routing for time-sensitive drone deliveries across different industries.</span>
          <div class="pill">
            <span class="pill-dot"></span>
            <span>Mayday</span>
          </div>
        </div>
      </div>

      <div class="login-side">
        <div class="side-card">
          <div class="side-card-title">What is Mayday?</div>
          <div class="side-tag">Overview</div>
          <p>
            Mayday lets you:
          </p>
          <ul style="margin-left: 18px; margin-top: 6px; line-height: 1.4;">
            <li>Log in as an operator</li>
            <li>Check missions between SoCal locations</li>
            <li>See which drones are in flight vs pending launch</li>
            <li>View a small analytics summary</li>
          </ul>
        </div>

        <div class="side-card">
          <div class="side-card-title">Tech used</div>
          <p>
            Frontend: HTML, CSS, vanilla JavaScript, Leaflet, Chart.js  
            Backend: Flask (Python), JSON APIs
          </p>
        </div>
      </div>
    </div>

    <!-- APP MAIN -->
    <div id="app-main">
      <aside class="sidebar">
        <div>
          <div class="sidebar-header">MAYDAY CONSOLE</div>

          <ul class="nav-list">
            <li class="nav-item">
              <button data-page="dashboard" class="active">
                <span class="icon">DB</span>
                Dashboard
              </button>
            </li>
            <li class="nav-item">
              <button data-page="drones">
                <span class="icon">DR</span>
                Drones
              </button>
            </li>
            <li class="nav-item">
              <button data-page="missions">
                <span class="icon">MI</span>
                Missions
              </button>
            </li>
            <li class="nav-item">
              <button data-page="analytics">
                <span class="icon">AN</span>
                Analytics
              </button>
            </li>
            <li class="nav-item">
              <button data-page="profile">
                <span class="icon">PR</span>
                Profile
              </button>
            </li>
            <li class="nav-item">
              <button data-page="settings">
                <span class="icon">ST</span>
                Settings
              </button>
            </li>
          </ul>
        </div>

        <div class="sidebar-footer">
          <button class="logout-btn" id="logout-btn">
            <span>Log out</span>
          </button>
        </div>
      </aside>

      <main class="content">
        <div class="content-header">
          <div class="content-header-left">
            <h2 id="page-title">Dashboard</h2>
            <p id="page-subtitle">Mission overview. </p>
          </div>
          <div class="user-chip" id="user-chip">
            <div class="user-avatar" id="user-avatar">OP</div>
            <div>
              <div id="user-name" style="font-size: 0.8rem;">Operator</div>
              <div style="font-size: 0.7rem; color: var(--muted-light);">Click to open profile</div>
            </div>
          </div>
        </div>

        <!-- DASHBOARD -->
        <section id="page-dashboard" class="page-section active">
          <div class="dashboard-grid">
       
            <div class="card">
              <div class="card-header">
                <div>
                  <h3>Check a mission</h3>
                  <p>Select a start and destination to check if the drone can make it safely.</p>
                  <p id="feasibility-mode-indicator" style="font-size: 0.78rem; color: var(--muted); margin-top: 2px;">
                    Using neural network feasibility model.
                  </p>
                </div>
                <span class="card-tag">Overview</span>
              </div>

              <form id="mission-form">
                <div class="form-grid">
                  <div class="field-group">
                    <label for="start-location">Start</label>
                    <div style="display: flex; gap: 8px; margin-bottom: 8px;">
                      <label style="display: flex; align-items: center; gap: 4px; font-size: 0.85rem; cursor: pointer; margin: 0;">
                        <input type="radio" name="start-type" value="preset" checked style="margin: 0; width: auto;" />
                        <span>Preset</span>
                      </label>
                      <label style="display: flex; align-items: center; gap: 4px; font-size: 0.85rem; cursor: pointer; margin: 0;">
                        <input type="radio" name="start-type" value="address" style="margin: 0; width: auto;" />
                        <span>Address</span>
                      </label>
                    </div>
                    <select id="start-location" required></select>
                    <input id="start-address" type="text" placeholder="Enter address (e.g., 123 Main St, Los Angeles, CA)" class="address-input" style="display: none; margin-top: 8px;" />
                  </div>
                  <div class="field-group">
                    <label for="end-location">Destination</label>
                    <div style="display: flex; gap: 8px; margin-bottom: 8px;">
                      <label style="display: flex; align-items: center; gap: 4px; font-size: 0.85rem; cursor: pointer; margin: 0;">
                        <input type="radio" name="end-type" value="preset" checked style="margin: 0; width: auto;" />
                        <span>Preset</span>
                      </label>
                      <label style="display: flex; align-items: center; gap: 4px; font-size: 0.85rem; cursor: pointer; margin: 0;">
                        <input type="radio" name="end-type" value="address" style="margin: 0; width: auto;" />
                        <span>Address</span>
                      </label>
                    </div>
                    <select id="end-location" required></select>
                    <input id="end-address" type="text" placeholder="Enter address (e.g., 456 Oak Ave, Santa Monica, CA)" class="address-input" style="display: none; margin-top: 8px;" />
                  </div>
                  <div class="field-group">
                    <label for="payload-weight">Payload (kg)</label>
                    <input id="payload-weight" type="number" min="0" step="0.1" value="1.0" required />
                  </div>
                  <div class="field-group">
                    <label for="battery-health">Battery health (%)</label>
                    <input id="battery-health" type="number" min="1" max="100" value="85" required />
                  </div>
                  <div class="field-group">
                    <label for="wind-speed">Wind speed (km/h) <span id="wind-auto-label" style="font-size: 0.75rem; color: var(--muted);">(auto)</span></label>
                    <input id="wind-speed" type="number" min="0" step="1" value="12" required readonly style="opacity: 0.7; cursor: not-allowed; background-color: var(--bg-secondary);" />
                  </div>
                  <div class="field-group">
                    <label for="wind-direction">Wind direction <span id="wind-dir-auto-label" style="font-size: 0.75rem; color: var(--muted);">(auto)</span></label>
                    <select id="wind-direction" disabled style="opacity: 0.7; cursor: not-allowed; background-color: var(--bg-secondary);">
                      <option value="headwind">Headwind</option>
                      <option value="tailwind">Tailwind</option>
                      <option value="crosswind">Crosswind</option>
                      <option value="calm">Calm</option>
                    </select>
                  </div>
                </div>

                <div class="mission-submit-row" style="display: flex; align-items: center; gap: 16px;">
                  <button type="submit" class="primary-btn">
                    Simulate mission
                    <span>▶</span>
                  </button>
                  <label style="display: flex; align-items: center; gap: 6px; margin: 0; font-size: 0.9rem; cursor: pointer;">
                    <input type="checkbox" id="manual-wind-toggle" style="margin: 0; width: auto;" />
                    <span>Manual wind settings</span>
                  </label>
                </div>
              </form>

              <div id="mission-status" class="status-banner" style="display: none;">
                <div class="status-dot"></div>
                <span id="mission-status-text"></span>
              </div>
            </div>

            <!-- Right: Map -->
            <div class="card">
              <div class="card-header">
                <div>
                  <h3>Route view</h3>
                </div>
                <span class="card-tag">Leaflet • OpenStreetMap</span>
              </div>
              <div id="map"></div>
            </div>
          </div>
        </section>

        <!-- DRONES -->
        <section id="page-drones" class="page-section">
          <div class="card" style="margin-bottom: 12px; background: var(--accent-soft); border: 1px solid rgba(248, 113, 113, 0.4);">
            <p style="margin: 0; color: var(--text); font-size: 0.86rem; line-height: 1.5;">
              <strong>Note:</strong> This is a mock drone page for demonstration purposes only. We do not have access to actual drones, so there is no real functionality. All data shown is simulated.
            </p>
          </div>
          <style>
            :root.light-mode #page-drones > .card:first-child p {
              color: #991b1b;
            }
          </style>
          <div class="drones-layout">
            <div class="card">
              <div class="card-header">
                <div>
                  <h3>Drones currently out</h3>
                  <p>Drones that are already in flight.</p>
                </div>
                <span class="card-tag">Mock view</span>
              </div>
              <div class="table-wrapper">
                <table>
                  <thead>
                    <tr>
                      <th>ID</th>
                      <th>Name</th>
                      <th>Battery</th>
                      <th>Mission</th>
                      <th>Action</th>
                    </tr>
                  </thead>
                  <tbody id="drones-out-body">
                    <!-- filled by JS -->
                  </tbody>
                </table>
              </div>
              <p class="note">Use “Mark completed” to bring a drone back from a mission.</p>
            </div>

            <div class="card">
              <div class="card-header">
                <div>
                  <h3>Drones about to be released</h3>
                  <p>Drones in a pending launch state.</p>
                </div>
              </div>
              <div class="table-wrapper">
                <table>
                  <thead>
                    <tr>
                      <th>ID</th>
                      <th>Name</th>
                      <th>Battery</th>
                      <th>Mission</th>
                      <th>Actions</th>
                    </tr>
                  </thead>
                  <tbody id="drones-pending-body">
                    <!-- filled by JS -->
                  </tbody>
                </table>
              </div>
              <p class="note">
                Launch will set the drone to “in flight” and drop its battery a bit, while cancel will move it back to idle.
              </p>
            </div>
          </div>
        </section>

        <!-- MISSIONS -->
        <section id="page-missions" class="page-section">
          <div class="card">
            <div class="card-header">
              <div>
                <h3>Mission history</h3>
                <p>Previous missions and their predicted outcome.</p>
              </div>
              <div>
                <select id="mission-filter">
                  <option value="all">All</option>
                  <option value="success">Successful</option>
                  <option value="fail">Failed</option>
                </select>
              </div>
            </div>
            <div class="table-wrapper">
              <table>
                <thead>
                  <tr>
                    <th>#</th>
                    <th>Route</th>
                    <th>Distance (km)</th>
                    <th>Battery</th>
                    <th>Payload</th>
                    <th>Wind</th>
                    <th>Result</th>
                  </tr>
                </thead>
                <tbody id="missions-table-body">
                </tbody>
              </table>
            </div>
            <p class="note">
            </p>
          </div>
        </section>

        <!-- ANALYTICS -->
        <section id="page-analytics" class="page-section">
          <div class="card">
            <div class="card-header">
              <div>
                <h3>Mission analytics</h3>
                <p>High-level success vs failure counts.</p>
              </div>
            </div>
            <div style="height: 220px; width: 100%; position: relative;">
              <canvas id="analytics-chart"></canvas>
            </div>
            <div class="analytics-legend">
              <span>Total: <span id="analytics-total">0</span></span>
              <span>Success rate: <span id="analytics-success-rate">0%</span></span>
            </div>
          </div>
        </section>

        <!-- PROFILE -->
        <section id="page-profile" class="page-section">
          <div class="profile-grid">
            <div class="card">
              <div class="card-header">
                <div>
                  <h3>Profile</h3>
                  <p>Information about the current operator.</p>
                </div>
              </div>
              <div class="profile-field">
                <span>Email</span>
                <span id="profile-email" style="color: var(--muted-light); font-size: 0.86rem;"></span>
              </div>
              <div class="profile-field">
                <label for="profile-name">Display name</label>
                <input id="profile-name" type="text" />
              </div>
              <div class="profile-field">
                <label for="profile-role">Role</label>
                <input id="profile-role" type="text" disabled />
              </div>
              <button id="profile-save-btn" class="primary-btn" style="margin-top: 10px; padding-inline: 16px;">
                Save profile
              </button>
              <p class="note">
              </p>
            </div>

            <div class="card">
              <div class="card-header">
                <div>
                  <h3>Theme</h3>
                </div>
              </div>
              <div class="profile-field">
                <label for="profile-theme">Theme</label>
                <select id="profile-theme">
                  <option value="dark">Dark</option>
                  <option value="light">Light</option>
                </select>
              </div>
              <p class="note">
              </p>
            </div>
          </div>
        </section>

        <!-- SETTINGS -->
        <section id="page-settings" class="page-section">
          <div class="card">
            <div class="card-header">
              <div>
                <h3>Simulation settings</h3>
                <p>Control how mission feasibility is evaluated.</p>
              </div>
            </div>
            <div style="margin-top: 4px;">
              <label style="font-size: 0.82rem;">
                <input type="checkbox" id="setting-aggressive-battery" />
                &nbsp;Treat low battery as riskier (aggressive model)
              </label>
            </div>
            <div style="margin-top: 6px;">
              <label style="font-size: 0.82rem;">
                <input type="checkbox" id="setting-strict-wind" />
                &nbsp;Block missions with strong headwind
              </label>
            </div>
            <div style="margin-top: 10px;">
              <div style="font-size: 0.82rem; margin-bottom: 4px;">Feasibility evaluation</div>
              <label style="font-size: 0.82rem; display: block; margin-bottom: 2px;">
                <input type="radio" name="feasibility-mode" id="setting-feas-mode-rule" value="rule" />
                &nbsp;Use rule-based feasibility (current heuristic)
              </label>
              <label style="font-size: 0.82rem; display: block;">
                <input type="radio" name="feasibility-mode" id="setting-feas-mode-model" value="model" checked />
                &nbsp;Use neural network feasibility model (scikit-learn)
              </label>
            </div>
            <div style="margin-top: 10px;">
              <button id="settings-save-btn" class="primary-btn" style="padding-inline: 16px;">
                Save settings
              </button>
            </div>
            <p class="note">
            </p>
          </div>
        </section>
      </main>
    </div>
  </div>

  <script>
    const API_BASE = "http://127.0.0.1:5000/api";

    const AppState = {
      token: null,
      user: null,
      locations: [],
      missions: [],
      drones: [],
      settings: {
        aggressiveBattery: false,
        strictWind: false,
        feasibilityMode: "model",
      },
    };

    let mapInstance = null;
    let routeLayer = null;
    let startMarker = null;
    let endMarker = null;
    let currentPathRequest = null;
    let analyticsChart = null;

    document.addEventListener("DOMContentLoaded", () => {
      const loginView = document.getElementById("login-view");
      const appMain = document.getElementById("app-main");
      const loginForm = document.getElementById("login-form");
      const signupForm = document.getElementById("signup-form");
      const switchToSignup = document.getElementById("switch-to-signup");
      const switchToLogin = document.getElementById("switch-to-login");
      const authTitle = document.getElementById("auth-title");
      const authSubtitle = document.getElementById("auth-subtitle");
      const logoutBtn = document.getElementById("logout-btn");
      const navButtons = document.querySelectorAll(".nav-item button");
      const pageTitle = document.getElementById("page-title");
      const pageSubtitle = document.getElementById("page-subtitle");
      const userChip = document.getElementById("user-chip");
      const userAvatar = document.getElementById("user-avatar");
      const userName = document.getElementById("user-name");
      const feasModeIndicator = document.getElementById("feasibility-mode-indicator");

      // Mission elements
      const missionForm = document.getElementById("mission-form");
      const missionStatusEl = document.getElementById("mission-status");
      const missionStatusTextEl = document.getElementById("mission-status-text");
      const missionFilter = document.getElementById("mission-filter");
      const missionsTableBody = document.getElementById("missions-table-body");

      // Drone elements
      const dronesOutBody = document.getElementById("drones-out-body");
      const dronesPendingBody = document.getElementById("drones-pending-body");

      // Profile elements
      const profileEmailEl = document.getElementById("profile-email");
      const profileNameEl = document.getElementById("profile-name");
      const profileRoleEl = document.getElementById("profile-role");
      const profileThemeEl = document.getElementById("profile-theme");
      const profileSaveBtn = document.getElementById("profile-save-btn");

      // Settings elements
      const settingAggressiveBattery = document.getElementById("setting-aggressive-battery");
      const settingStrictWind = document.getElementById("setting-strict-wind");
      const settingFeasModeRule = document.getElementById("setting-feas-mode-rule");
      const settingFeasModeModel = document.getElementById("setting-feas-mode-model");
      const settingsSaveBtn = document.getElementById("settings-save-btn");

      // --- Initialization of map & chart will happen after login ---

      // Try to restore token from localStorage
      const storedToken = localStorage.getItem("maydayToken");
      if (storedToken) {
        AppState.token = storedToken;
        showApp(); // will call /me to verify
      } else {
        showLogin();
      }

      function showLogin() {
        loginView.style.display = "flex";
        appMain.style.display = "none";
      }

      async function showApp() {
        loginView.style.display = "none";
        appMain.style.display = "flex";

        try {
          await fetchCurrentUser();
          await Promise.all([fetchLocations(), fetchDrones(), fetchMissions()]);
          // load settings after user data is fetched
          await loadSettings();
        } catch (err) {
          console.error(err);
          const message = (err && err.message ? err.message.toLowerCase() : "");
          
          // if the token is missing or no longer valid, treat this as a session issue, not a backend outage
          if (message.includes("no token provided") || message.includes("invalid or expired token") || message.includes("401")) {
            AppState.token = null;
            AppState.user = null;
            localStorage.removeItem("maydayToken");
            alert("your session is not valid anymore. please log in again.");
          } else {
            alert("could not contact backend. is flask running?");
          }
          showLogin();
          return;
        }

        // Update UI with user info
        userName.textContent = AppState.user.name || "Operator";
        userAvatar.textContent = (AppState.user.name || "O").charAt(0).toUpperCase();

        // Fill profile page
        profileEmailEl.textContent = AppState.user.email;
        profileNameEl.value = AppState.user.name || "";
        profileRoleEl.value = AppState.user.role || "Operator";
        profileThemeEl.value = AppState.user.theme || "dark";
        // apply theme on page load
        applyTheme(AppState.user.theme || "dark");

        // Initialize map & selects
        initializeMap();
        populateLocationSelects();
        setupLocationToggles();

        // Render drones & missions & analytics
        renderDrones();
        renderMissionsTable();
        initializeAnalyticsChart();
        updateAnalytics();
        updateFeasibilityIndicator();
      }

      // ------------- API helpers -------------

      async function apiRequest(path, options = {}) {
        const headers = options.headers || {};
        if (AppState.token) {
          headers["Authorization"] = "Bearer " + AppState.token;
        }
        if (!(options.body instanceof FormData)) {
          headers["Content-Type"] = "application/json";
        }

        const res = await fetch(API_BASE + path, {
          ...options,
          headers,
        });

        if (!res.ok) {
          const text = await res.text();
          throw new Error(text || ("Request failed: " + res.status));
        }
        return res.json();
      }

      async function fetchCurrentUser() {
        const data = await apiRequest("/me", { method: "GET" });
        AppState.user = data;
      }

      async function fetchLocations() {
        const data = await apiRequest("/locations", { method: "GET" });
        AppState.locations = data;
      }

      async function fetchDrones() {
        const data = await apiRequest("/drones", { method: "GET" });
        AppState.drones = data;
      }

      async function fetchMissions() {
        const data = await apiRequest("/missions", { method: "GET" });
        AppState.missions = data;
      }

      // ------------- LOGIN -------------

      // Toggle between login and signup forms
      switchToSignup.addEventListener("click", (e) => {
        e.preventDefault();
        loginForm.style.display = "none";
        signupForm.style.display = "block";
        authTitle.textContent = "Create your account";
        authSubtitle.textContent = "Join Mayday to start managing drone delivery operations.";
      });

      switchToLogin.addEventListener("click", (e) => {
        e.preventDefault();
        signupForm.style.display = "none";
        loginForm.style.display = "block";
        authTitle.textContent = "Sign in to your console";
        authSubtitle.textContent = "Track drones, missions, and manage delivery routes in one place.";
      });

      // Signup form handler
      signupForm.addEventListener("submit", async (e) => {
        e.preventDefault();
        const name = document.getElementById("signup-name").value.trim();
        const email = document.getElementById("signup-email").value.trim().toLowerCase();
        const password = document.getElementById("signup-password").value;
        const passwordConfirm = document.getElementById("signup-password-confirm").value;

        if (!name || !email || !password || !passwordConfirm) {
          alert("Please fill in all fields.");
          return;
        }

        if (password.length < 6) {
          alert("Password must be at least 6 characters long.");
          return;
        }

        if (password !== passwordConfirm) {
          alert("Passwords do not match.");
          return;
        }

        try {
          const res = await fetch(API_BASE + "/signup", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ name, email, password }),
          });

          const data = await res.json();

          if (!res.ok) {
            alert(data.error || "Signup failed. Please try again.");
            return;
          }

          AppState.token = data.token;
          AppState.user = data.user;
          localStorage.setItem("maydayToken", data.token);
          // apply theme before showing app
          if (data.user && data.user.theme) {
            applyTheme(data.user.theme);
          }
          await showApp();
        } catch (err) {
          console.error("Signup error:", err);
          alert("Signup failed. Please check your connection and try again.");
        }
      });

      // Login form handler
      loginForm.addEventListener("submit", async (e) => {
        e.preventDefault();
        const email = document.getElementById("login-email").value.trim().toLowerCase();
        const password = document.getElementById("login-password").value;

        if (!email || !password) {
          alert("Please enter both email and password.");
          return;
        }

        try {
          const res = await fetch(API_BASE + "/login", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ email, password }),
          });

          const data = await res.json();

          if (!res.ok) {
            alert(data.error || "Login failed. Please check your credentials.");
            return;
          }

          AppState.token = data.token;
          AppState.user = data.user;
          localStorage.setItem("maydayToken", data.token);
          // apply theme before showing app
          if (data.user && data.user.theme) {
            applyTheme(data.user.theme);
          }
          await showApp();
        } catch (err) {
          console.error(err);
          alert("Could not reach backend. Make sure Flask is running.");
        }
      });

      logoutBtn.addEventListener("click", () => {
        AppState.token = null;
        AppState.user = null;
        localStorage.removeItem("maydayToken");
        showLogin();
      });

      // Clicking avatar opens profile page
      userChip.addEventListener("click", () => {
        setActivePage("profile");
        navButtons.forEach((b) => b.classList.remove("active"));
        document.querySelector('button[data-page="profile"]').classList.add("active");
      });

      // ------------- NAVIGATION -------------

      navButtons.forEach((btn) => {
        btn.addEventListener("click", () => {
          const page = btn.getAttribute("data-page");
          setActivePage(page);
          navButtons.forEach((b) => b.classList.remove("active"));
          btn.classList.add("active");
        });
      });

      function setActivePage(page) {
        const sections = document.querySelectorAll(".page-section");
        sections.forEach((sec) => sec.classList.remove("active"));
        const active = document.getElementById(`page-${page}`);
        if (active) active.classList.add("active");

        switch (page) {
          case "dashboard":
            pageTitle.textContent = "Dashboard";
            pageSubtitle.textContent = "Mission simulation and quick status overview.";
            break;
          case "drones":
            pageTitle.textContent = "Drones";
            pageSubtitle.textContent = "Drones already out vs drones about to be released.";
            break;
          case "missions":
            pageTitle.textContent = "Missions";
            break;
          case "analytics":
            pageTitle.textContent = "Analytics";
            pageSubtitle.textContent = "High-level performance across missions.";
            break;
          case "profile":
            pageTitle.textContent = "Profile";
            pageSubtitle.textContent = "Operator information and preferences.";
            break;
          case "settings":
            pageTitle.textContent = "Settings";
            pageSubtitle.textContent = "Simulation rules and feasibility model configuration.";
            break;
        }
      }

      function updateFeasibilityIndicator() {
        if (!feasModeIndicator) return;
        const mode = (AppState.settings.feasibilityMode || "model").toLowerCase();
        if (mode === "model") {
          feasModeIndicator.textContent = "Using neural network feasibility model.";
        } else {
          feasModeIndicator.textContent = "Using rule-based feasibility model.";
        }
      }

      // ------------- MAP & LOCATIONS -------------

      function initializeMap() {
        if (mapInstance) return;
        const defaultCenter = [33.882, -117.8854]; // CSUF
        mapInstance = L.map("map").setView(defaultCenter, 9);

        L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
          maxZoom: 19,
          attribution: "&copy; OpenStreetMap contributors",
        }).addTo(mapInstance);
      }

      function populateLocationSelects() {
        const startSelect = document.getElementById("start-location");
        const endSelect = document.getElementById("end-location");

        [startSelect, endSelect].forEach((select) => {
          select.innerHTML = "";
          AppState.locations.forEach((loc) => {
            const opt = document.createElement("option");
            opt.value = loc.id;
            opt.textContent = loc.name;
            select.appendChild(opt);
          });
        });

        if (startSelect.options.length > 0) startSelect.selectedIndex = 0;
        if (endSelect.options.length > 1) endSelect.selectedIndex = 1;
      }

      function getLocationById(id) {
        return AppState.locations.find((loc) => loc.id === id);
      }

      // Setup location type toggles
      function setupLocationToggles() {
        const startPresetRadio = document.querySelector('input[name="start-type"][value="preset"]');
        const startAddressRadio = document.querySelector('input[name="start-type"][value="address"]');
        const endPresetRadio = document.querySelector('input[name="end-type"][value="preset"]');
        const endAddressRadio = document.querySelector('input[name="end-type"][value="address"]');
        const startSelect = document.getElementById("start-location");
        const startAddress = document.getElementById("start-address");
        const endSelect = document.getElementById("end-location");
        const endAddress = document.getElementById("end-address");

        function toggleStartInputs() {
          if (startPresetRadio.checked) {
            startSelect.style.display = "block";
            startSelect.required = true;
            startAddress.style.display = "none";
            startAddress.required = false;
            startAddress.value = "";
          } else {
            startSelect.style.display = "none";
            startSelect.required = false;
            startAddress.style.display = "block";
            startAddress.required = true;
          }
        }

        function toggleEndInputs() {
          if (endPresetRadio.checked) {
            endSelect.style.display = "block";
            endSelect.required = true;
            endAddress.style.display = "none";
            endAddress.required = false;
            endAddress.value = "";
          } else {
            endSelect.style.display = "none";
            endSelect.required = false;
            endAddress.style.display = "block";
            endAddress.required = true;
          }
        }

        startPresetRadio.addEventListener("change", toggleStartInputs);
        startAddressRadio.addEventListener("change", toggleStartInputs);
        endPresetRadio.addEventListener("change", toggleEndInputs);
        endAddressRadio.addEventListener("change", toggleEndInputs);
      }

      // Geocoding function using OpenStreetMap Nominatim API
      async function geocodeAddress(address) {
        if (!address || address.trim() === "") {
          throw new Error("Address cannot be empty");
        }

        const url = `https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(address)}&limit=1`;
        const maxAttempts = 3;
        let lastError = null;

        for (let attempt = 1; attempt <= maxAttempts; attempt++) {
          try {
            const response = await fetch(url, {
              headers: {
                'User-Agent': 'mayday-drone-pathfinding/1.0' // required by nominatim
              }
            });

            if (!response.ok) {
              lastError = new Error(`geocoding api returned status ${response.status}`);
            } else {
              const data = await response.json();
              
              if (!data || data.length === 0) {
                // this is a real "not found", no need to retry further
                throw new Error("address not found. please try a more specific address.");
              }

              const result = data[0];
              return {
                lat: parseFloat(result.lat),
                lng: parseFloat(result.lon),
                display_name: result.display_name
              };
            }
          } catch (error) {
            // if this is a clear "not found", bubble it up immediately
            if (error.message && error.message.toLowerCase().includes("not found")) {
              throw error;
            }
            lastError = error;
          }

          // small backoff between retries, but do not block too long
          if (attempt < maxAttempts) {
            await new Promise(resolve => setTimeout(resolve, 500 * attempt));
          }
        }

        const message = lastError && lastError.message
          ? lastError.message
          : "could not contact address lookup service.";
        throw new Error(`failed to geocode address after multiple attempts: ${message}`);
      }

      function drawRoute(start, end, calculatedPath = null) {
        if (!mapInstance) return;

        const startLatLng = [start.lat, start.lng];
        const endLatLng = [end.lat, end.lng];

        if (routeLayer) {
          mapInstance.removeLayer(routeLayer);
          routeLayer = null;
        }

        if (startMarker) {
          mapInstance.removeLayer(startMarker);
          startMarker = null;
        }

        if (endMarker) {
          mapInstance.removeLayer(endMarker);
          endMarker = null;
        }

        if (calculatedPath && calculatedPath.length > 0) {
          const pathCoords = calculatedPath.map(p => [p[0], p[1]]);
          routeLayer = L.polyline(pathCoords, { 
            weight: 4, 
            color: '#3b82f6',
            smoothFactor: 1.0
          }).addTo(mapInstance);
          mapInstance.fitBounds(routeLayer.getBounds(), { padding: [40, 40] });
        } else {
          routeLayer = L.polyline([startLatLng, endLatLng], { weight: 4, color: '#94a3b8' }).addTo(mapInstance);
          mapInstance.fitBounds(routeLayer.getBounds(), { padding: [40, 40] });
        }

        startMarker = L.circleMarker(startLatLng, { radius: 5, color: 'green' }).addTo(mapInstance);
        endMarker = L.circleMarker(endLatLng, { radius: 5, color: 'red' }).addTo(mapInstance);
      }

      // ------------- MISSION SIM -------------

      missionForm.addEventListener("submit", async (e) => {
        e.preventDefault();

        const payload = parseFloat(document.getElementById("payload-weight").value);
        const battery = parseFloat(document.getElementById("battery-health").value);
        const windSpeed = parseFloat(document.getElementById("wind-speed").value);
        const windDirection = document.getElementById("wind-direction").value;

        // Determine if using preset or address for start
        const startType = document.querySelector('input[name="start-type"]:checked').value;
        let start = null;
        let startName = "";

        if (startType === "preset") {
          const startId = document.getElementById("start-location").value;
          start = getLocationById(startId);
          if (!start) {
            showMissionStatus("Please select a start location.", false);
            return;
          }
          startName = start.name;
        } else {
          const startAddress = document.getElementById("start-address").value.trim();
          if (!startAddress) {
            showMissionStatus("Please enter a start address.", false);
            return;
          }
          try {
            showMissionStatus("Geocoding start address...", null, true);
            const geocoded = await geocodeAddress(startAddress);
            start = { lat: geocoded.lat, lng: geocoded.lng, name: geocoded.display_name };
            startName = geocoded.display_name;
          } catch (error) {
            showMissionStatus(`Error: ${error.message}`, false);
            return;
          }
        }

        // Determine if using preset or address for end
        const endType = document.querySelector('input[name="end-type"]:checked').value;
        let end = null;
        let endName = "";

        if (endType === "preset") {
          const endId = document.getElementById("end-location").value;
          end = getLocationById(endId);
          if (!end) {
            showMissionStatus("Please select a destination location.", false);
            return;
          }
          endName = end.name;
        } else {
          const endAddress = document.getElementById("end-address").value.trim();
          if (!endAddress) {
            showMissionStatus("Please enter a destination address.", false);
            return;
          }
          try {
            if (startType === "address") {
              showMissionStatus("Geocoding destination address...", null, true);
            } else {
              showMissionStatus("Geocoding destination address...", null, true);
            }
            const geocoded = await geocodeAddress(endAddress);
            end = { lat: geocoded.lat, lng: geocoded.lng, name: geocoded.display_name };
            endName = geocoded.display_name;
          } catch (error) {
            showMissionStatus(`Error: ${error.message}`, false);
            return;
          }
        }

        // Check if start and end are the same
        if (start.lat === end.lat && start.lng === end.lng) {
          showMissionStatus("Start and destination cannot be the same location.", false);
          return;
        }

        let distance = haversine(start.lat, start.lng, end.lat, end.lng);

        const manualWindToggle = document.getElementById("manual-wind-toggle");
        const useWeatherAPI = !manualWindToggle.checked;
        
        if (useWeatherAPI) {
          showMissionStatus("Calculating optimal path and fetching weather data...", null, true);
          
          // Reset wind fields to show they're being calculated
          const windSpeedInput = document.getElementById("wind-speed");
          const windDirectionSelect = document.getElementById("wind-direction");
          windSpeedInput.value = "12";
          windSpeedInput.style.opacity = "0.5";
          windDirectionSelect.value = "calm";
          windDirectionSelect.style.opacity = "0.5";
        } else {
          showMissionStatus("Calculating optimal path...", null, true);
        }
        
        drawRoute(start, end);
        
        if (currentPathRequest) {
          currentPathRequest.abort();
        }
        
        const controller = new AbortController();
        currentPathRequest = controller;
        
        fetch(`${API_BASE}/path?start_lat=${start.lat}&start_lng=${start.lng}&end_lat=${end.lat}&end_lng=${end.lng}&use_weather=${useWeatherAPI}`, {
          signal: controller.signal
        })
          .then(async res => {
            const pathData = await res.json();
            if (!res.ok) {
              throw new Error(pathData.error || 'Failed to calculate path');
            }
            return pathData;
          })
          .then(async pathData => {
            if (currentPathRequest === controller) {
              // check if API failed
              if (pathData.api_failed || pathData.error) {
                const errorMsg = pathData.error || 'failed to fetch obstacle data from api.';
                showMissionStatus(`${errorMsg} using direct path (obstacles not avoided).`, false, false);
                if (pathData.path) {
                  drawRoute(start, end, pathData.path);
                  distance = pathData.distance_km || haversine(start.lat, start.lng, end.lat, end.lng);
                } else {
                  drawRoute(start, end);
                  distance = haversine(start.lat, start.lng, end.lat, end.lng);
                }
                currentPathRequest = null;
                return;
              }
              
              // update wind fields automatically from api response only if not in manual mode
              const manualWindToggle = document.getElementById("manual-wind-toggle");
              if (!manualWindToggle.checked) {
                const windSpeedInput = document.getElementById("wind-speed");
                const windDirectionSelect = document.getElementById("wind-direction");
                
                if (pathData.wind_speed !== undefined && pathData.wind_speed !== null) {
                  windSpeedInput.value = pathData.wind_speed;
                  windSpeedInput.style.opacity = "1"; // make visible when populated
                }
                
                if (pathData.wind_direction !== undefined && pathData.wind_direction !== null) {
                  windDirectionSelect.value = pathData.wind_direction;
                  windDirectionSelect.style.opacity = "1"; // make visible when populated
                }
              }
              
              // read updated wind values for mission evaluation
              const windSpeed = parseFloat(document.getElementById("wind-speed").value);
              const windDirection = document.getElementById("wind-direction").value;
              
              if (pathData.weather_api_failed && pathData.weather_error) {
                showMissionStatus(`${pathData.weather_error} using default wind values for this mission.`, false, false);
              }
              
              if (pathData.distance_km) {
                distance = pathData.distance_km;
              }
              drawRoute(start, end, pathData.path);
              
              const { success, reason } = await evaluateMissionServer(
                distance,
                payload,
                battery,
                windSpeed,
                windDirection
              );
              
              const text = success
                ? `mission feasible: ${distance.toFixed(1)} km route calculated. ${reason}`
                : `mission not recommended: ${distance.toFixed(1)} km route calculated. ${reason}`;
              showMissionStatus(text, success, false);
              
              try {
                const result = await apiRequest("/missions", {
                  method: "POST",
                  body: JSON.stringify({
                    start: startName,
                    end: endName,
                    distance_km: distance.toFixed(2),
                    payload_kg: payload,
                    battery,
                    wind_speed: windSpeed,
                    wind_direction: windDirection,
                    result: success ? "success" : "fail",
                  }),
                });
                AppState.missions.unshift(result);
                renderMissionsTable();
                updateAnalytics();
              } catch (err) {
                console.error("Failed to save mission (auth required):", err);
              }
              
              currentPathRequest = null;
            }
          })
          .catch(async error => {
            if (error.name !== 'AbortError') {
              console.error("Pathfinding error:", error);
              const errorMsg = error.message || 'failed to calculate path.';
              const fallbackMsg = `${errorMsg} api could not be reached, using direct path only (obstacles not avoided).`;
              
              distance = haversine(start.lat, start.lng, end.lat, end.lng);
              drawRoute(start, end);
              
              const { success, reason } = await evaluateMissionServer(
                distance,
                payload,
                battery,
                windSpeed,
                windDirection
              );
              const resultText = success
                ? `mission feasible: ${distance.toFixed(1)} km (straight-line). ${reason}`
                : `mission not recommended: ${distance.toFixed(1)} km (straight-line). ${reason}`;
              
              showMissionStatus(`${fallbackMsg} ${resultText}`, success, false);
              
              try {
                const result = await apiRequest("/missions", {
                  method: "POST",
                  body: JSON.stringify({
                    start: startName,
                    end: endName,
                    distance_km: distance.toFixed(2),
                    payload_kg: payload,
                    battery,
                    wind_speed: windSpeed,
                    wind_direction: windDirection,
                    result: success ? "success" : "fail",
                  }),
                });
                AppState.missions.unshift(result);
                renderMissionsTable();
                updateAnalytics();
              } catch (err) {
                console.error("Failed to save mission (auth required):", err);
              }
            }
            if (currentPathRequest === controller) {
              currentPathRequest = null;
            }
          });

      });

      function showMissionStatus(text, success, isLoading = false) {
        missionStatusEl.style.display = "flex";
        missionStatusTextEl.textContent = text;
        missionStatusEl.classList.remove("negative", "loading");
        missionStatusEl.querySelector(".status-dot").classList.remove("danger", "spinning");
        
        if (isLoading) {
          missionStatusEl.classList.add("loading");
          missionStatusEl.querySelector(".status-dot").classList.add("spinning");
        } else if (success === false) {
          missionStatusEl.classList.add("negative");
          missionStatusEl.querySelector(".status-dot").classList.add("danger");
        }
      }

      function haversine(lat1, lon1, lat2, lon2) {
        const R = 6371;
        const dLat = toRad(lat2 - lat1);
        const dLon = toRad(lon2 - lon1);
        const a =
          Math.sin(dLat / 2) * Math.sin(dLat / 2) +
          Math.cos(toRad(lat1)) *
            Math.cos(toRad(lat2)) *
            Math.sin(dLon / 2) *
            Math.sin(dLon / 2);
        const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
        return R * c;
      }

      function toRad(v) {
        return (v * Math.PI) / 180;
      }

      function evaluateMission(distanceKm, payloadKg, batteryPercent, windSpeed, windDirection) {
        let cost = distanceKm * 0.5 + payloadKg * 0.8 + windSpeed * 0.25;

        if (AppState.settings.aggressiveBattery) cost *= 1.15;
        if (AppState.settings.strictWind && windDirection === "headwind" && windSpeed > 20) {
          return {
            success: false,
            reason: "Strict wind rule: headwind above 20 km/h blocks the mission.",
          };
        }

        const margin = batteryPercent - cost;
        const success = margin > 12 && batteryPercent > 35;

        let reason = "";
        if (success) {
          reason =
            "Battery margin is above the safety threshold. Mission is likely to succeed.";
        } else {
          reason =
            "Battery margin or health is too low. The drone might not make a safe return.";
        }

        return { success, reason };
      }

      async function evaluateMissionServer(distanceKm, payloadKg, batteryPercent, windSpeed, windDirection) {
        const mode = (AppState.settings.feasibilityMode || "model").toLowerCase();

        if (mode === "model") {
          try {
            const res = await apiRequest("/feasibility", {
              method: "POST",
              body: JSON.stringify({
                distance_km: distanceKm,
                payload_kg: payloadKg,
                battery_percent: batteryPercent,
                wind_speed: windSpeed,
                wind_direction: windDirection,
              }),
            });

            if (res && typeof res.success === "boolean") {
              return {
                success: res.success,
                reason: res.reason || "",
                modeUsed: res.mode_used || "model",
              };
            }
          } catch (err) {
            console.error("feasibility model evaluation failed, falling back to rule:", err);
            // fall through to rule-based evaluation
          }
        }

        const ruleResult = evaluateMission(distanceKm, payloadKg, batteryPercent, windSpeed, windDirection);
        return {
          success: ruleResult.success,
          reason: ruleResult.reason,
          modeUsed: "rule",
        };
      }

      // ------------- MISSIONS TABLE -------------

      missionFilter.addEventListener("change", () => {
        renderMissionsTable();
      });

      function renderMissionsTable() {
        missionsTableBody.innerHTML = "";
        const filter = missionFilter.value;

        AppState.missions.forEach((m, index) => {
          if (filter === "success" && m.result !== "success") return;
          if (filter === "fail" && m.result !== "fail") return;

          const tr = document.createElement("tr");
          tr.innerHTML = `
            <td>${AppState.missions.length - index}</td>
            <td>${m.start} → ${m.end}</td>
            <td>${m.distance_km}</td>
            <td>${m.battery}%</td>
            <td>${m.payload_kg} kg</td>
            <td>${m.wind_speed} km/h (${m.wind_direction})</td>
            <td>
              <span class="badge-status ${
                m.result === "success" ? "success" : "fail"
              }">
                ${m.result.toUpperCase()}
              </span>
            </td>
          `;
          missionsTableBody.appendChild(tr);
        });
      }

      // ------------- DRONES -------------

      function renderDrones() {
        dronesOutBody.innerHTML = "";
        dronesPendingBody.innerHTML = "";

        AppState.drones.forEach((d) => {
          if (d.status === "in_flight") {
            const tr = document.createElement("tr");
            tr.innerHTML = `
              <td>${d.id}</td>
              <td>${d.name}</td>
              <td>${d.battery}%</td>
              <td>${d.current_mission || "-"}</td>
              <td>
                <button class="secondary-btn" data-action="complete" data-id="${d.id}">
                  Mark completed
                </button>
              </td>
            `;
            dronesOutBody.appendChild(tr);
          } else if (d.status === "pending_launch") {
            const tr = document.createElement("tr");
            tr.innerHTML = `
              <td>${d.id}</td>
              <td>${d.name}</td>
              <td>${d.battery}%</td>
              <td>${d.current_mission || "-"}</td>
              <td>
                <button class="secondary-btn" data-action="launch" data-id="${d.id}">
                  Launch
                </button>
                <button class="secondary-btn" data-action="cancel" data-id="${d.id}">
                  Cancel
                </button>
              </td>
            `;
            dronesPendingBody.appendChild(tr);
          }
        });

        // Attach click handlers
        dronesOutBody.querySelectorAll("button").forEach((btn) => {
          btn.addEventListener("click", () => handleDroneAction(btn));
        });
        dronesPendingBody.querySelectorAll("button").forEach((btn) => {
          btn.addEventListener("click", () => handleDroneAction(btn));
        });
      }

      async function handleDroneAction(btn) {
        const action = btn.getAttribute("data-action");
        const id = parseInt(btn.getAttribute("data-id"), 10);

        try {
          let status;
          if (action === "complete") status = "idle";
          if (action === "launch") status = "in_flight";
          if (action === "cancel") status = "idle";

          const updated = await apiRequest(`/drones/${id}/status`, {
            method: "POST",
            body: JSON.stringify({
              status,
              mission_code: `MANUAL-${id}`,
            }),
          });

          // update local state
          const index = AppState.drones.findIndex((d) => d.id === id);
          if (index !== -1) {
            AppState.drones[index] = updated;
          }
          renderDrones();
        } catch (err) {
          console.error(err);
          alert("Unable to update drone status. Check backend.");
        }
      }

      // ------------- PROFILE -------------

      // apply theme to the page
      function applyTheme(theme) {
        const root = document.documentElement;
        if (theme === "light") {
          root.classList.add("light-mode");
        } else {
          root.classList.remove("light-mode");
        }
      }

      profileSaveBtn.addEventListener("click", async () => {
        const newName = profileNameEl.value.trim();
        const newTheme = profileThemeEl.value;
        
        if (!newName) {
          alert("Display name cannot be empty.");
          return;
        }
        
        try {
          const updated = await apiRequest("/profile", {
            method: "POST",
            body: JSON.stringify({ name: newName, theme: newTheme }),
          });
          AppState.user = updated;
          userName.textContent = updated.name || "Operator";
          userAvatar.textContent = (updated.name || "O").charAt(0).toUpperCase();
          // update profile fields to reflect saved values
          profileNameEl.value = updated.name || "";
          profileThemeEl.value = updated.theme || "dark";
          // apply theme immediately
          applyTheme(updated.theme || "dark");
          alert("Profile saved successfully.");
        } catch (err) {
          console.error(err);
          const errorMsg = err.message || "Could not save profile.";
          alert(errorMsg.includes("error") ? errorMsg : "Could not save profile.");
        }
      });

      // apply theme when user changes it in the selector
      profileThemeEl.addEventListener("change", () => {
        applyTheme(profileThemeEl.value);
      });

      // ------------- SETTINGS -------------

      // load settings on page load
      async function loadSettings() {
        try {
          const settings = await apiRequest("/settings", { method: "GET" });
          AppState.settings.aggressiveBattery = settings.aggressive_battery || false;
          AppState.settings.strictWind = settings.strict_wind || false;
          AppState.settings.feasibilityMode = settings.feasibility_mode || "model";
          settingAggressiveBattery.checked = AppState.settings.aggressiveBattery;
          settingStrictWind.checked = AppState.settings.strictWind;
          if (settingFeasModeRule && settingFeasModeModel) {
            if ((AppState.settings.feasibilityMode || "model").toLowerCase() === "model") {
              settingFeasModeModel.checked = true;
            } else {
              settingFeasModeRule.checked = true;
            }
          }
          updateFeasibilityIndicator();
        } catch (err) {
          console.error("Could not load settings:", err);
        }
      }

      // save settings when changed
      async function saveSettings() {
        try {
          await apiRequest("/settings", {
            method: "POST",
            body: JSON.stringify({
              aggressive_battery: AppState.settings.aggressiveBattery,
              strict_wind: AppState.settings.strictWind,
              feasibility_mode: AppState.settings.feasibilityMode
            }),
          });
          updateFeasibilityIndicator();
        } catch (err) {
          console.error("Could not save settings:", err);
        }
      }

      settingAggressiveBattery.addEventListener("change", async () => {
        AppState.settings.aggressiveBattery = settingAggressiveBattery.checked;
        await saveSettings();
      });

      settingStrictWind.addEventListener("change", async () => {
        AppState.settings.strictWind = settingStrictWind.checked;
        await saveSettings();
      });
      
      if (settingFeasModeRule) {
        settingFeasModeRule.addEventListener("change", async () => {
          if (settingFeasModeRule.checked) {
            AppState.settings.feasibilityMode = "rule";
            await saveSettings();
          }
        });
      }

      if (settingFeasModeModel) {
        settingFeasModeModel.addEventListener("change", async () => {
          if (settingFeasModeModel.checked) {
            AppState.settings.feasibilityMode = "model";
            await saveSettings();
          }
        });
      }
      
      if (settingsSaveBtn) {
        settingsSaveBtn.addEventListener("click", async () => {
          await saveSettings();
          alert("settings saved.");
        });
      }
      
      // load settings when app loads
      loadSettings();

      // Manual wind toggle
      const manualWindToggle = document.getElementById("manual-wind-toggle");
      const windSpeedInput = document.getElementById("wind-speed");
      const windDirectionSelect = document.getElementById("wind-direction");
      const windAutoLabel = document.getElementById("wind-auto-label");
      const windDirAutoLabel = document.getElementById("wind-dir-auto-label");

      function updateWindFieldsState() {
        const isManual = manualWindToggle.checked;
        
        if (isManual) {
          // manual mode: enable fields
          windSpeedInput.removeAttribute("readonly");
          windSpeedInput.style.opacity = "1";
          windSpeedInput.style.cursor = "text";
          windSpeedInput.style.backgroundColor = "";
          windDirectionSelect.disabled = false;
          windDirectionSelect.style.opacity = "1";
          windDirectionSelect.style.cursor = "pointer";
          windDirectionSelect.style.backgroundColor = "";
          windAutoLabel.textContent = "";
          windDirAutoLabel.textContent = "";
        } else {
          // auto mode: disable fields
          windSpeedInput.setAttribute("readonly", "readonly");
          windSpeedInput.style.opacity = "0.7";
          windSpeedInput.style.cursor = "not-allowed";
          windSpeedInput.style.backgroundColor = "var(--bg-secondary)";
          windDirectionSelect.disabled = true;
          windDirectionSelect.style.opacity = "0.7";
          windDirectionSelect.style.cursor = "not-allowed";
          windDirectionSelect.style.backgroundColor = "var(--bg-secondary)";
          windAutoLabel.textContent = "(auto)";
          windDirAutoLabel.textContent = "(auto)";
        }
      }

      manualWindToggle.addEventListener("change", updateWindFieldsState);
      updateWindFieldsState(); // initialize state

      // ------------- ANALYTICS -------------

      function initializeAnalyticsChart() {
        if (analyticsChart) return;
        const ctx = document.getElementById("analytics-chart").getContext("2d");

        analyticsChart = new Chart(ctx, {
          type: "bar",
          data: {
            labels: ["Successful", "Failed"],
            datasets: [
              {
                label: "Missions",
                data: [0, 0],
                base: 0
              },
            ],
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: { legend: { display: false } },
            animation: {
              x: {
                duration: 0,
                from: NaN
              },
              y: {
                from: 0
              },
              width: {
                duration: 0
              },
              height: {
                from: 0
              }
            },
            scales: {
              x: {
                ticks: { color: "#9ca3af", font: { size: 11 } },
                grid: { display: false },
              },
              y: {
                beginAtZero: true,
                ticks: { color: "#9ca3af", font: { size: 11 }, precision: 0 },
                grid: { color: "rgba(55, 65, 81, 0.8)" },
              },
            },
          },
        });
      }

      function updateAnalytics() {
        const total = AppState.missions.length;
        const successCount = AppState.missions.filter((m) => m.result === "success").length;
        const failCount = total - successCount;
        document.getElementById("analytics-total").textContent = total;
        const rate = total === 0 ? 0 : Math.round((successCount / total) * 100);
        document.getElementById("analytics-success-rate").textContent = rate + "%";

        if (analyticsChart) {
          analyticsChart.data.datasets[0].data = [successCount, failCount];
          analyticsChart.update({
            duration: 800,
            easing: 'easeOutQuart'
          });
        }
      }
    });
  </script>
</body>
</html>
